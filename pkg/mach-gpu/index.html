<!doctype html><html><head><link rel=stylesheet href=https://machengine.org/layouts/default.1b9540ff392b51b0b809690caf746c7ec39a7048990a55170087510406bf5e62.css><link rel=apple-touch-icon sizes=180x180 href=https://machengine.org//apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://machengine.org//favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://machengine.org//favicon-16x16.png><link rel=manifest href=https://machengine.org//site.webmanifest><link rel=mask-icon href=https://machengine.org//safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://machengine.org//assets/font/stylesheet.css><link rel=stylesheet href=https://machengine.org//assets/font/inter/inter.css><script async defer data-domain=hexops.com src=https://machengine.org//opendata.js></script><meta charset=utf-8><title>mach gpu | Mach: zig game engine & graphics toolkit</title><link rel=canonical href=https://machengine.org/pkg/mach-gpu/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="mach gpu"><meta property="og:description" content="The WebGPU interface for Zig"><meta property="og:type" content="article"><meta property="og:url" content="https://machengine.org/pkg/mach-gpu/"><meta property="og:image" content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_28a6532840d06fd94cb747bab475356f.png"><meta property="article:section" content="pkg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_28a6532840d06fd94cb747bab475356f.png"><meta name=twitter:title content="mach gpu"><meta name=twitter:description content="The WebGPU interface for Zig"></head><body><div class=navbar><div class=content><a href=https://machengine.org// class=logo><div class=img></div></a><div class=subsection><a href=https://machengine.org//engine class=item>Engine</a>
<a href=https://machengine.org//core class=item>Core</a>
<a href=https://machengine.org//pkg class=item>Packages</a>
<a href=https://machengine.org//about class=item>Project</a></div><div class="divider color-border">&nbsp;</div><div class=subsection><a href=https://devlog.hexops.com/categories/mach/ class=item>Devlog</a>
<a href=https://github.com/hexops/mach class=svg-item><img alt=GitHub class=svg-icon src=https://machengine.org//img/github.svg></a>
<a href=https://discord.gg/XNG3NZgCqp class=svg-item><img alt=Discord class=svg-icon src=https://machengine.org//img/discord.svg></a>
<a href=https://github.com/sponsors/slimsag class=donate-button><img alt=Heart class=svg-icon src=https://machengine.org//img/heart.svg>
&nbsp;Donate</a></div></div></div><div class=alert><span><strong>Mach v0.3 has been released!</strong> For all the details check out <a href=https://devlog.hexops.com/2024/mach-v0.3-released/>the announcement</a></span></div><div id=content><link rel=stylesheet href=https://machengine.org/layouts/docs.1c549ac5e9eaa1dc4997cd957caa9afec046a45d465b64074e1ec4f88737dd7b.css><main aria-role=main class="main-docs with-alert"><aside><ul><li><a href=https://machengine.org/pkg><span>Packages overview</span></a></li><li><a href=https://machengine.org/pkg/c><span>C libraries / headers</span></a></li><li><h3><span>Pure Zig</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/pkg/mach-ecs>ecs</a></li><li><a href=https://machengine.org/pkg/mach-sysaudio>sysaudio</a></li><li><a href=https://machengine.org/pkg/mach-sysjs>sysjs</a></li><li><a href=https://machengine.org/pkg/mach-sysgpu>sysgpu</a></li><li><a href=https://machengine.org/pkg/mach-gamemode>gamemode</a></li><li><a href=https://machengine.org/pkg/fastfilter>fastfilter</a></li></ul><li><h3><span>Bindings</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/pkg/mach-gpu>gpu</a></li><li><a href=https://machengine.org/pkg/mach-gpu-dawn>gpu-dawn</a></li><li><a href=https://machengine.org/pkg/mach-basisu>basisu</a></li><li><a href=https://machengine.org/pkg/mach-freetype>freetype</a></li><li><a href=https://machengine.org/pkg/mach-dxcompiler>dxcompiler</a></li><li><a href=https://machengine.org/pkg/mach-glfw>glfw</a></li><li><a href=https://machengine.org/pkg/mach-model3d>model3d</a></li><li><a href=https://machengine.org/pkg/mach-opus>opus</a></li><li><a href=https://machengine.org/pkg/mach-flac>flac</a></li></ul></ul></aside><div class=docs><div class=centered><picture><source media="(prefers-color-scheme: dark)" srcset=https://machengine.org/assets/mach/gpu-full-dark.svg><img alt=mach-gpu src=https://machengine.org/assets/mach/gpu-full-light.svg style=height:7rem;margin-top:1rem></picture>
<span><a href=https://github.com/hexops/mach-gpu>GitHub repository</a> | <a href="https://github.com/hexops/mach/issues?q=is%3Aissue+is%3Aopen+label%3Agpu">Issue tracker</a></span></div><p>The WebGPU interface for Zig, featuring:</p><ul><li><a href=../../about/goals#zero-fuss-installation>Zero-fuss</a> installation, <a href=../../about/goals#seamless-cross-compilation>cross-compilation</a> at the flip of a switch, and <a href=../../about/platforms>broad platform support</a>.</li><li>100% API coverage. Every function, type, constant, etc. has been exposed in a ziggified API.</li><li>Desktop, Steam Deck, (soon) web, and (future) mobile support.</li><li>A modern graphics API similar to Metal, Vulkan, and DirectX 12.</li><li>Cross-platform shading language</li><li>Compute shaders</li><li>Advanced GPU features where hardware support is available.</li></ul><h2 id=benefits-of-machgpu-and-webgpu>Benefits of mach/gpu and WebGPU</h2><p><code>mach/gpu</code> is a zero-cost idiomatic Zig interface to <a href=https://www.w3.org/TR/webgpu/>the next-generation WebGPU API</a>, which supersedes WebGL and exposes the common denominator between the latest low-level graphics APIs (Vulkan, Metal, D3D12) in the web.</p><p>Despite its name, <a href=http://kvark.github.io/web/gpu/native/2020/05/03/point-of-webgpu-native.html>WebGPU was built with native support in mind</a> and has substantial investment from Mozilla, Google, Microsoft, Intel, and Apple.</p><p>When targeting WebAssembly, <code>mach/gpu</code> merely calls into the browser&rsquo;s native WebGPU implementation.</p><p>When targeting native platforms, we build Google Chrome&rsquo;s WebGPU implementation, <a href=https://dawn.googlesource.com/dawn>Dawn</a> using Zig as the C/C++ compiler toolchain. We bypass the client-server sandboxing model, and use <code>zig build</code> (plus a lot of hand-holding) to support zero-fuss cross compilation & installation without any third-party Google tools, libraries, etc. Just <code>zig</code> and <code>git</code> needed, nothing else.</p><h2 id=perfecting-webgpu-for-zig>Perfecting WebGPU for Zig</h2><p>There is a detailed write-up of how we&rsquo;ve been <a href=https://devlog.hexops.com/2022/perfecting-webgpu-native>perfecting WebGPU for Zig</a>.</p><h2 id=usage>Usage</h2><p>On your own, this involves creating a window (using GLFW, and other APIs if you want Web, Mobile, or other platform support), using Dawn&rsquo;s API to create a device and bind it to that window, using OS-specific APIs to get the window handle to bind, etc. <code>examples/main.zig</code> demonstrates how to do this. There&rsquo;s a fair amount of setup code involved.</p><p>You may also want to consider using <em>Mach core</em>.</p><h2 id=goals>Goals</h2><ul><li>Allow comptime-defined interception of WebGPU API requests (comptime interfaces.)</li><li>Expose a standard Dawn <code>webgpu.h</code>-compliant C ABI, which routes through Zig comptime interfaces.</li><li>Support Dawn and Browser (via WASM/JS) implementations of WebGPU.</li><li>Broad platform support: desktop, mobile, web, consoles.</li><li>First-class Linux support (Wayland, OpenGL and OpenGL ES fallbacks, etc.)</li></ul><h2 id=non-goals>Non-goals</h2><ul><li>Support non-Dawn (e.g. Rust WebGPU) implementations if they don&rsquo;t match the same <code>webgpu.h</code> as Dawn.</li><li>Maintain backwards compatibility with deprecated <code>webgpu.h</code> methods.</li></ul><h2 id=getting-started>Getting started</h2><p>Create a <code>build.zig.zon</code> in your project (replace <code>LATEST_COMMIT</code> with the latest commit hash):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span>.{
</span></span><span style=display:flex><span>    .name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mypkg&#34;</span>,
</span></span><span style=display:flex><span>    .version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.1.0&#34;</span>,
</span></span><span style=display:flex><span>    .dependencies <span style=color:#f92672>=</span> .{
</span></span><span style=display:flex><span>        .mach_gpu <span style=color:#f92672>=</span> .{
</span></span><span style=display:flex><span>            .url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://pkg.machengine.org/mach-gpu/LATEST_COMMIT.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Run <code>zig build</code> in your project, and the compiler will instruct you to add a <code>.hash = "..."</code> field next to <code>.url</code>:</p><pre tabindex=0><code>note: expected .hash = &#34;12209838fcfb7a77d2d6931efdc7448c033a1b7dad11d082c94bbeeba9d1038cd311&#34;,
</code></pre><p>Then use the dependency in your <code>build.zig</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> build(b<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>std.Build) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    exe.root_module.addImport(<span style=color:#e6db74>&#34;mach-gpu&#34;</span>, b.dependency(<span style=color:#e6db74>&#34;mach_gpu&#34;</span>, .{
</span></span><span style=display:flex><span>        .target <span style=color:#f92672>=</span> target,
</span></span><span style=display:flex><span>        .optimize <span style=color:#f92672>=</span> optimize,
</span></span><span style=display:flex><span>    }).module(<span style=color:#e6db74>&#34;mach-gpu&#34;</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can now use it in your <code>src/main.zig</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>const</span> gpu <span style=color:#f92672>=</span> @import(<span style=color:#e6db74>&#34;mach-gpu&#34;</span>);
</span></span></code></pre></div><h3 id=ran-into-trouble>Ran into trouble?</h3><p>Triple-check you followed the <code>build.zig.zon</code> instructions correctly, it&rsquo;s easy to mess that part up.</p><p>Feel free to join the <a href=../../discord>Mach Discord community</a> for help.</p><h2 id=quality-of-life-improvements>Quality of life improvements</h2><p>We make the following quality of life improvements.</p><h3 id=flag-sets>Flag sets</h3><p>See <a href=https://devlog.hexops.com/2022/perfecting-webgpu-native>perfecting WebGPU for Zig</a>.</p><h3 id=optionality--nullability>Optionality & nullability</h3><ul><li>Optional values default to their zero value (either <code>null</code> or a struct constructor <code>.{}</code>) when specified as <code>optional</code> in <code>dawn.json</code>. This means things like <code>label</code>, <code>next_in_chain</code>, etc. do not need to be specified.</li><li>Fields representing a slice with a <code>_count</code> field are nullable pointers defaulting to null and 0 by default.</li></ul><h3 id=slice-helpers>Slice helpers</h3><p>Some WebGPU APIs expose slices as pointers and lengths, we either wrap these to provide a slice or alter the method directly to provide a slice (if little overhead.) The original C-style API can always be accessed via the <code>gpu.Impl</code> type in any case.</p><p>The slice helpers are:</p><ul><li><code>Adapter.enumerateFeaturesOwned</code></li><li><code>Buffer.getConstMappedRange</code></li><li><code>Buffer.getMappedRange</code></li><li><code>CommandEncoder.writeBuffer</code></li><li><code>ComputePassEncoder.setBindGroup</code></li><li><code>Device.enumerateFeaturesOwned</code></li><li><code>Queue.writeTexture</code></li><li><code>Queue.writeBuffer</code></li><li><code>RenderPassEncoder.executeBundles</code></li><li><code>RenderBundleEncoder.setBindGroup</code></li><li><code>RenderPassEncoder.setBindGroup</code></li></ul><p>And, to initialize data structures with slices in them, the following helpers are provided:</p><ul><li><code>BindGroupLayout.Descriptor.init</code></li><li><code>BindGroup.Descriptor.init</code></li><li><code>dawn.TogglesDescriptor.init</code></li><li><code>Device.Descriptor.init</code></li><li><code>PipelineLayout.Descriptor.init</code></li><li><code>QuerySet.Descriptor.init</code></li><li><code>RenderBundleEncoder.Descriptor.init</code></li><li><code>Texture.Descriptor.init</code></li><li><code>ComputePassDescriptor.init</code></li><li><code>RenderPassDescriptor.init</code></li><li><code>ProgrammableStageDescriptor.init</code></li><li><code>VertexBufferLayout.init</code></li><li><code>VertexState.init</code></li><li><code>FragmentState.init</code></li><li><code>CompilationInfo.getMessages</code></li></ul><h3 id=typed-callbacks>Typed callbacks</h3><p>Most WebGPU callbacks provide a way to provide a <code>userdata: *anyopaque</code> pointer to the callback for context. We alter these APIs to expose a typed context pointer instead (again, the original API is always available via the <code>gpu.Impl</code> type should you want it):</p><ul><li><code>Instance.requestAdapter</code></li><li><code>Adapter.requestDevice</code></li><li><code>Queue.onSubmittedWorkDone</code></li><li><code>Buffer.mapAsync</code></li><li><code>ShaderModule.getCompilationInfo</code></li><li><code>Device.createComputePipelineAsync</code></li><li><code>Device.createRenderPipelineAsync</code></li><li><code>Device.popErrorScope</code></li><li><code>Device.setDeviceLostCallback</code></li><li><code>Device.setLoggingCallback</code></li><li><code>Device.setUncapturedErrorCallback</code></li></ul><h3 id=next_in_chain-extension-type-safety>next_in_chain extension type safety</h3><p>WebGPU exposes struct types which are extendable arbitrarily, often by implementation-specific extensions. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>const</span> extension <span style=color:#f92672>=</span> gpu.Surface.DescriptorFromWindowsHWND{
</span></span><span style=display:flex><span>  .chain <span style=color:#f92672>=</span> gpu.ChainedStruct{.next <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>, .s_type <span style=color:#f92672>=</span> .surface_descriptor_from_windows_hwnd},
</span></span><span style=display:flex><span>  .hinstance <span style=color:#f92672>=</span> foo,
</span></span><span style=display:flex><span>  .hwnd <span style=color:#f92672>=</span> bar,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> descriptor <span style=color:#f92672>=</span> gpu.Surface.Descriptor{
</span></span><span style=display:flex><span>  .next_in_chain <span style=color:#f92672>=</span> @ptrCast(<span style=color:#f92672>?*</span><span style=color:#66d9ef>const</span> ChainedStruct, <span style=color:#f92672>&amp;</span>extension),
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Here <code>gpu.Surface.Descriptor</code> is a concrete type. The <code>next_in_chain</code> field is set to an arbitrary pointer which follows the <code>gpu.ChainedStruct</code> pattern: it must begin with a <code>gpu.ChainedStruct</code> where the <code>s_type</code> identifies which fields may follow after, and <code>.next</code> could theoretically chain more extensions on too.</p><p>Complexity aside, <code>next_in_chain</code> is not type safe! It cannot be, because such an extension could be implementation-specific. To make this safer, we instead change the <code>next_in_chain</code> field type to be a union, where one option is the type-unsafe <code>generic</code> pointer, and the other options are known extensions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> NextInChain <span style=color:#f92672>=</span> <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>    generic<span style=color:#f92672>:</span> <span style=color:#f92672>?*</span><span style=color:#66d9ef>const</span> ChainedStruct,
</span></span><span style=display:flex><span>    from_windows_hwnd<span style=color:#f92672>:</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> DescriptorFromWindowsHWND,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><p>Additionally we initialize <code>.chain</code> with a default value, making our earlier snippet look like this in most cases:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>const</span> descriptor <span style=color:#f92672>=</span> gpu.Surface.Descriptor{
</span></span><span style=display:flex><span>  .next_in_chain <span style=color:#f92672>=</span> .{.from_windows_hwnd <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>.{
</span></span><span style=display:flex><span>    .hinstance <span style=color:#f92672>=</span> foo,
</span></span><span style=display:flex><span>    .hwnd <span style=color:#f92672>=</span> bar,
</span></span><span style=display:flex><span>  }},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=others>Others</h3><ul><li><code>Device.createShaderModuleWGSL</code> (helper to create WGSL shader modules more nicely)</li></ul><p>There may be other opportunities for helpers, to improve the existing APIs, or add utility APIs on top of the existing APIs. If you find one, please open an issue we&rsquo;d love to consider it.</p></div><div class=toc><h3>Table of contents</h3><nav id=TableOfContents><ul><li><a href=#benefits-of-machgpu-and-webgpu>Benefits of mach/gpu and WebGPU</a></li><li><a href=#perfecting-webgpu-for-zig>Perfecting WebGPU for Zig</a></li><li><a href=#usage>Usage</a></li><li><a href=#goals>Goals</a></li><li><a href=#non-goals>Non-goals</a></li><li><a href=#getting-started>Getting started</a><ul><li><a href=#ran-into-trouble>Ran into trouble?</a></li></ul></li><li><a href=#quality-of-life-improvements>Quality of life improvements</a><ul><li><a href=#flag-sets>Flag sets</a></li><li><a href=#optionality--nullability>Optionality & nullability</a></li><li><a href=#slice-helpers>Slice helpers</a></li><li><a href=#typed-callbacks>Typed callbacks</a></li><li><a href=#next_in_chain-extension-type-safety>next_in_chain extension type safety</a></li><li><a href=#others>Others</a></li></ul></li></ul></nav></div></main><div class=footer><a href=https://hexops.com/privacy>Privacy matters</a><p><a href=https://github.com/hexops/machengine.org/archive/refs/heads/gh-pages.zip>offline version of this site</a> | <a href=https://machengine.org//about#improve-this-site>Improve this site</a> | <a href=https://github.com/sponsors/slimsag>Sponsor on GitHub</a> | <a href=https://devlog.hexops.com/>Hexops' devlog</a></p></div></div></body></html>