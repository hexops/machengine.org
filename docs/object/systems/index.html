<!doctype html><html><head><link rel=stylesheet href=https://machengine.org/layouts/default.bb15466819d3fbaf312db7ece8726d7131ba9ed50eeb5e347de909b3f0b89c48.css><link rel=apple-touch-icon sizes=180x180 href=https://machengine.org//apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://machengine.org//favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://machengine.org//favicon-16x16.png><link rel=manifest href=https://machengine.org//site.webmanifest><link rel=mask-icon href=https://machengine.org//safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://machengine.org//assets/font/stylesheet.css><link rel=stylesheet href=https://machengine.org//assets/font/inter/inter.css><script async defer data-domain=hexops.com src=https://machengine.org//opendata.js></script><meta charset=utf-8><title>Object system: systems | Mach: zig game engine & graphics toolkit</title><link rel=canonical href=https://machengine.org/docs/object/systems/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Object system: systems"><meta property="og:description" content="Mach modules may contain systems: functions, or a list of systems (functions), that could be run if desired."><meta property="og:type" content="article"><meta property="og:url" content="https://machengine.org/docs/object/systems/"><meta property="og:image" content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_94437dfacb78b3e74accbad56f478450.png"><meta property="article:section" content="docs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_94437dfacb78b3e74accbad56f478450.png"><meta name=twitter:title content="Object system: systems"><meta name=twitter:description content="Mach modules may contain systems: functions, or a list of systems (functions), that could be run if desired."></head><body><div class=navbar><div class=content><a href=https://machengine.org// class=logo><div class=img></div></a><div class=subsection><a href=https://machengine.org//docs class=item>Docs</a>
<a href=https://machengine.org//about class=item>Project</a></div><div class="divider color-border">&nbsp;</div><div class=subsection><a href=https://devlog.hexops.com/categories/mach/ class=item>Devlog</a>
<a href=https://github.com/hexops/mach class=svg-item><img alt=GitHub class=svg-icon src=https://machengine.org//img/github.svg></a>
<a href=https://discord.gg/XNG3NZgCqp class=svg-item><img alt=Discord class=svg-icon src=https://machengine.org//img/discord.svg></a>
<a href=https://github.com/sponsors/slimsag class=donate-button><img alt=Heart class=svg-icon src=https://machengine.org//img/heart.svg>
&nbsp;Donate</a></div></div></div><div id=content><link rel=stylesheet href=https://machengine.org/layouts/docs.145a7d0caf5b3345083bed4fb10383d5bbda5c3cfd5a83cc7a153b0afbd8b2eb.css><main aria-role=main class=main-docs><aside><ul><li><a href=https://machengine.org/docs><span>Overview</span></a></li><li><a href=https://machengine.org/docs/getting-started><span>Getting started</span></a></li><li><h3><span>Object system</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/object>Overview</a></li><li><a href=https://machengine.org/docs/object/modules>Modules</a></li><li><a href=https://machengine.org/docs/object/systems>Systems</a></li><li><a href=https://machengine.org/docs/object/objects>Objects</a></li><li><a href=https://machengine.org/docs/object/relations>Relations</a></li></ul><li><h3><span>Math</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/math>Overview</a></li><li><a href=https://machengine.org/docs/math/coordinate-system>Coordinate system</a></li><li><a href=https://machengine.org/docs/math/traversing-coordinate-systems>Traversing coordinate systems</a></li><li><a href=https://machengine.org/docs/math/matrix-storage>Matrix storage</a></li></ul><li><h3><span>GPU</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/gpu>Overview</a></li><li><a href=https://machengine.org/docs/gpu/memory>Memory management</a></li><li><a href=https://machengine.org/docs/gpu/errors>Error handling</a></li></ul><li><h3><span>General</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/roadmap>Roadmap</a></li><li><a href=https://machengine.org/docs/modularity>Modularity</a></li><li><a href=https://machengine.org/docs/stdlib>Standard library</a></li><li><a href=https://machengine.org/docs/zig-version>Zig version</a></li><li><a href=https://machengine.org/docs/nominated-zig>Nominated Zig</a></li></ul></ul></aside><div class=docs><h1 id=object-system-systems>Object system: systems</h1><p>Mach systems are a key concept of <a href=../>the Mach object system</a>. Systems are functions, or a list of systems (functions), that could be run if desired.</p><h2 id=declaring-systems>Declaring systems</h2><p>To declare a system, one simply needs to add the name of the system to a <code>pub const mach_systems</code> list in the <a href=../modules>module</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> mach_module <span style=color:#f92672>=</span> .foo;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> mach_systems <span style=color:#f92672>=</span> .{ .init, .tick, .deinit };
</span></span></code></pre></div><p>The names written in this list (<code>.init</code>, <code>.tick</code>, <code>.deinit</code>) can be whatever we like, since we&rsquo;re <em>declaring them</em>.</p><p>If a system is named in the <code>mach_systems</code> list, then there must also be a <em>public function</em> or <em>public schedule</em> of the same name in the module:</p><p><strong>public function</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> tick() <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// could do something interesting here!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>public schedule</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> init <span style=color:#f92672>=</span> mach.schedule(.{
</span></span><span style=display:flex><span>    .{ OtherModule, .init }, <span style=color:#75715e>// run OtherModule&#39;s .init system first,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    .{ App, .start },        <span style=color:#75715e>// then afterwards run App&#39;s .start system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span></code></pre></div><p>Systems are ultimately just functions (or lists of functions) that <em>could</em> be run if someone wants them to. They don&rsquo;t do anything by default.</p><h2 id=injected-arguments>Injected arguments</h2><p>Above, we wrote a <code>tick</code> system function which had no arguments - system functions actually have <em>injected</em> arguments which means we can accept <em>any Mach module that exists in the whole program</em> as an argument, and when Mach calls the function it will just provide it for you!</p><pre tabindex=0><code>pub fn tick(app: *App, other_mod: mach.Mod(Other), other: *Other) void {
    // Access App modules&#39; global state
    app.counter += 1;

    // Access Other modules&#39; global state
    other.counter += 1;

    // Run Other module&#39;s system (covered more in the next section)
    other_mod.run(.tick);
}
</code></pre><p>This is really powerful because it means that if you suddenly find that one part of your large/complex codebase needs to access another module&rsquo;s state, or work with another module&rsquo;s objects, etc. then it can simply write that in its function signature and that&rsquo;s it! You don&rsquo;t have to go chase down all the call sites of that function and provide a new parameter - Mach handles it for you.</p><p>A consequence of this is that <em>only Mach can provide arguments to your system functions</em> - you cannot pass arbitrary arguments. This is actually a feature to help you write more performant code, which we&rsquo;ll get into later in the <a href=../objects>objects</a> section.</p><p>Note: you can always write functions that take arbitrary arguments in your Mach module - they just don&rsquo;t qualify as valid <em>systems</em>.</p><h2 id=running-systems>Running systems</h2><p>By default, systems don&rsquo;t run ever. They only run if someone tells Mach to run them. One way to do this is via the <code>mach.Mod(T).run()</code> function, like what we saw in the <code>main.zig</code> example in the <a href=../modules>modules section</a>:</p><pre tabindex=0><code>pub fn main() !void {
    // ...

    // Pass control to our App.zig module.
    const app: mach.Mod(App) = mods.get(.app);
    app.run(.main);
}
</code></pre><p>As you can see, if we have a Mach module like our <code>App.zig</code> from earlier, then we can use the <code>mach.Mod(App).run</code> function to invoke a system called <code>.main</code>.</p><p>Since <strong>systems are globally addressible</strong> (every system of every module in the entire program is known), and since we know the system name <code>.main</code> at comptime in this case, this can boil down to a simple function call which can even be inlined! There are a few subtle differences from a function call though:</p><ul><li>Mach knows the name of the system AND the name of the function, and can <em>observe how long the function takes to run</em> - super useful for debugging performance problems!</li><li>Instead of you passing in the arguments, Mach looks at the function signature and injects whichever are needed!</li><li>If the system isn&rsquo;t a function but rather a <code>mach.schedule</code> (list of systems to be ran), Mach runs each one-after-the-other sequentially and can observe each of them independently for debugging purposes!</li></ul><h2 id=callbacks>Callbacks</h2><p>As mentioned above, <code>mach.Mod(App).run(.fooBar)</code> takes a system name <code>.fooBar</code> that is <em>comptime known</em>. Sometimes you don&rsquo;t know at compile time what other system you&rsquo;d like to run.</p><p>For example, perhaps your module will handle GUI windows for the application, and you need the user of your module to be able to specify what system should run when it is time to render a new frame to the window. In that case your application might store <em>function IDs</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> mach_module <span style=color:#f92672>=</span> .gui_windows;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>on_render<span style=color:#f92672>:</span> <span style=color:#f92672>?</span>mach.SystemID <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> update(windows<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>@This(), windows_mod<span style=color:#f92672>:</span> mach.Mod(@This())) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Call whatever function is set in on_render.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    windows_mod.call(windows.on_render.<span style=color:#f92672>?</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now your module doesn&rsquo;t have to be aware of what exact system should run when rendering a frame should happen, and instead the user of your module can register that callback:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> mach_module <span style=color:#f92672>=</span> .app;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> mach_systems <span style=color:#f92672>=</span> .{ .init, .render };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> init(app_mod<span style=color:#f92672>:</span> mach.Mod(@This()), windows<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>Windows) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When the windowing library wants to render a new frame, have it run our app&#39;s .render system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    windows.on_render <span style=color:#f92672>=</span> app_mod.id.render;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> render() <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Note how our App module takes a <code>app_mod</code> parameter: Mach knows how to inject two parameter types:</p><ul><li>A Module struct <code>M</code> itself (like our <code>App</code> module)<ul><li>Gives access to a module&rsquo;s global state for example.</li></ul></li><li>A <code>mach.Mod(M)</code> struct (like <code>mach.Mod(App)</code>) - typically called e.g. <code>&lt;module>_mod</code> like <code>app_mod</code><ul><li>Gives access to a <code>app_mod.run(.foo)</code> method which can run that module&rsquo;s comptime-known systems.</li><li>Gives access to a <code>app_mod.call(system_id)</code> method which can run <em>any</em> system from any module, given its ID.</li><li>Gives access to <code>app_mod.id</code> struct, which contains an system ID for <em>every system in that module</em>, e.g. <code>app_mod.id.init</code> and <code>app_mod.id.render</code> would both be valid since our <code>App</code> module has <code>pub const mach_systems = .{ .init, .render };</code></li></ul></li></ul><h2 id=systems-should-run-_unconditionally_>Systems should run <em>unconditionally</em></h2><p>Although you have the ability to call systems at runtime and comptime from within another system&rsquo;s execution, you generally should avoid running systems <em>conditionally</em>.</p><p>For example, let&rsquo;s say you have two systems - one which spawns monsters, and one which processes newly spawned monsters.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> spawnMonsters(monsters<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>Monsters) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Maybe spawn some monsters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// run processMonsterUpdates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> processNewMonsters(monsters<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>Monsters) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If there are new monsters, process them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>what you should <strong>never</strong> do is this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> spawnMonsters(monsters<span style=color:#f92672>:</span> <span style=color:#f92672>*</span>Monsters, monsters_mod<span style=color:#f92672>:</span> mach.Mod(Monsters)) <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (monsters.amount_to_spawn) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BAD!:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (monsters.amount_to_spawn <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) monsters_mod.run(.processNewMonsters);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// GOOD!:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// monsters_mod.run(.processNewMonsters);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>This code conditionally runs the <code>processNewMonsters</code> system only if <code>monsters.amount_to_spawn > 0</code> - at first this might make sense: If no new monsters were spawned, then why run <code>processNewMonsters</code>? But this is not good because /someone else/ may have spawned monster objects (a debugger, a GUI editor, a different module that recieves updates over a network, etc.) and they won&rsquo;t know to call <code>processNewMonsters</code> after doing so.</p><p>Instead, <code>processNewMonsters</code> should always be run and just written to return quickly if there are no new monsters to process for example.</p><p>At this point we should look at <em>objects</em> - because objects are a key concept of the object system which plays into <em>why systems should run unconditionally</em> as well as <em>why system functions cannot have arbitrary arguments</em>: <strong><em>modules communicate via objects!</em></strong></p><h2 id=continue-reading-systems>Continue reading: systems</h2><p><a href=../objects>Object system: objects</a></p></div><div class=toc><h3>Table of contents</h3><nav id=TableOfContents><ul><li><a href=#declaring-systems>Declaring systems</a></li><li><a href=#injected-arguments>Injected arguments</a></li><li><a href=#running-systems>Running systems</a></li><li><a href=#callbacks>Callbacks</a></li><li><a href=#systems-should-run-_unconditionally_>Systems should run <em>unconditionally</em></a></li><li><a href=#continue-reading-systems>Continue reading: systems</a></li></ul></nav></div></main><div class=footer><a href=https://hexops.com/privacy>Privacy matters</a><p><a href=https://github.com/hexops/machengine.org/archive/refs/heads/gh-pages.zip>offline version of this site</a> | <a href=https://machengine.org//about#improve-this-site>Improve this site</a> | <a href=https://github.com/sponsors/slimsag>Sponsor on GitHub</a> | <a href=https://devlog.hexops.com/>Hexops' devlog</a></p></div></div></body></html>