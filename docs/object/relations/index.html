<!doctype html><html><head><link rel=stylesheet href=https://machengine.org/layouts/default.bb15466819d3fbaf312db7ece8726d7131ba9ed50eeb5e347de909b3f0b89c48.css><link rel=apple-touch-icon sizes=180x180 href=https://machengine.org//apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://machengine.org//favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://machengine.org//favicon-16x16.png><link rel=manifest href=https://machengine.org//site.webmanifest><link rel=mask-icon href=https://machengine.org//safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://machengine.org//assets/font/stylesheet.css><link rel=stylesheet href=https://machengine.org//assets/font/inter/inter.css><script async defer data-domain=hexops.com src=https://machengine.org//opendata.js></script><meta charset=utf-8><title>Object system: relations | Mach: zig game engine & graphics toolkit</title><link rel=canonical href=https://machengine.org/docs/object/relations/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Object system: relations"><meta property="og:description" content="Mach object relations enable you to arbitrarily create parent-child relations between objects, or attach arbitrary data to objects."><meta property="og:type" content="article"><meta property="og:url" content="https://machengine.org/docs/object/relations/"><meta property="og:image" content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_7669835120a60899519d062100ed5a98.png"><meta property="article:section" content="docs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://machengine.org/opengraph/template_hu102e162f47cb7d8ae9eb284939698b9d_62022_7669835120a60899519d062100ed5a98.png"><meta name=twitter:title content="Object system: relations"><meta name=twitter:description content="Mach object relations enable you to arbitrarily create parent-child relations between objects, or attach arbitrary data to objects."></head><body><div class=navbar><div class=content><a href=https://machengine.org// class=logo><div class=img></div></a><div class=subsection><a href=https://machengine.org//docs class=item>Docs</a>
<a href=https://machengine.org//about class=item>Project</a></div><div class="divider color-border">&nbsp;</div><div class=subsection><a href=https://devlog.hexops.com/categories/mach/ class=item>Devlog</a>
<a href=https://github.com/hexops/mach class=svg-item><img alt=GitHub class=svg-icon src=https://machengine.org//img/github.svg></a>
<a href=https://discord.gg/XNG3NZgCqp class=svg-item><img alt=Discord class=svg-icon src=https://machengine.org//img/discord.svg></a>
<a href=https://github.com/sponsors/emidoots class=donate-button><img alt=Heart class=svg-icon src=https://machengine.org//img/heart.svg>
&nbsp;Donate</a></div></div></div><div id=content><link rel=stylesheet href=https://machengine.org/layouts/docs.145a7d0caf5b3345083bed4fb10383d5bbda5c3cfd5a83cc7a153b0afbd8b2eb.css><main aria-role=main class=main-docs><aside><ul><li><a href=https://machengine.org/docs><span>Overview</span></a></li><li><a href=https://machengine.org/docs/getting-started><span>Getting started</span></a></li><li><h3><span>Object system</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/object>Overview</a></li><li><a href=https://machengine.org/docs/object/modules>Modules</a></li><li><a href=https://machengine.org/docs/object/systems>Systems</a></li><li><a href=https://machengine.org/docs/object/objects>Objects</a></li><li><a href=https://machengine.org/docs/object/relations>Relations</a></li></ul><li><h3><span>Math</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/math>Overview</a></li><li><a href=https://machengine.org/docs/math/coordinate-system>Coordinate system</a></li><li><a href=https://machengine.org/docs/math/traversing-coordinate-systems>Traversing coordinate systems</a></li><li><a href=https://machengine.org/docs/math/matrix-storage>Matrix storage</a></li></ul><li><h3><span>GPU</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/gpu>Overview</a></li><li><a href=https://machengine.org/docs/gpu/memory>Memory management</a></li><li><a href=https://machengine.org/docs/gpu/errors>Error handling</a></li></ul><li><h3><span>General</span></h3></li><ul class=sub-menu><li><a href=https://machengine.org/docs/roadmap>Roadmap</a></li><li><a href=https://machengine.org/docs/modularity>Modularity</a></li><li><a href=https://machengine.org/docs/stdlib>Standard library</a></li><li><a href=https://machengine.org/docs/zig-version>Zig version</a></li><li><a href=https://machengine.org/docs/nominated-zig>Nominated Zig</a></li></ul></ul></aside><div class=docs><h1 id=object-system-relations>Object system: relations</h1><p>Mach object <em>relations</em> are a key concept of <a href=../>the Mach object system</a> and enable you to arbitrarily create parent-child relations between objects.</p><p>Among other things, this allows for attaching <em>your own arbitrary data</em> to <em>someone else&rsquo;s object</em> - a form of relaxed type constraint which enable you to quickly iterate on your codebase. *<em>Mach&rsquo;s object system is not an Entity Component System</em> (<a href=../objects#key-difference-from-entity-component-systems>it&rsquo;s better!</a>), but ECS typically enables this form of relaxed type constraint to enable fast iteration - and <em>object relations</em> are how we provide this flexibility.</p><h2 id=relations-are-objectid---objectid>Relations are ObjectID &lt;-> ObjectID</h2><p>As discussed in <a href=../objects#object-ids>the objects section</a>, objects have IDs which pack a bunch of information including which module and set of objects the ID came from, the actual array index for O(1) lookups, a generation counter for use-after-free detection, and more.</p><p>Mach stores parent-child relations as a mapping of object IDs pointing to other object IDs. This means that you can attach say a <code>monster</code> object to a <code>window</code> object - they don&rsquo;t have to be from the same module or same list of objects.</p><h2 id=the-parallelism-problem>The parallelism problem</h2><p>One challenge in representing object relations on top of <a href=../objects><code>mach.Objects</code></a> is that - since each is a list of objects <em>owned by someone</em> - potentially different threads! If we want to allow objects from <em>one list of objects</em> to have parents and children in <em>another list of objects</em> which are owned by a different thread.. things get tricky!</p><p>A naive solution to this might be to introduce a global mutex around the graph of object relations. Unfortunately, this would mean that any thread interacting with object relations is blocked on every other thread looking to do the same (Hello, Python interpreter GIL, anyone?)</p><p>Mach uses a much more clever solution (thanks to some fantastic advice from kprotty, the famous program optimizer, concurrency/IO guy, and Zig core team member.)</p><h2 id=how-machs-object-system-stores-relations>How Mach&rsquo;s object system stores relations</h2><p>Mach maintains a single global object graph, where objects owned by any threads&rsquo; can have parents/children which are themselves objects owned by other threads'.</p><p>The trick is that instead of maintaining a global mutex (or using <em>any locks at all</em>), we enable reads/writes/mutations to the graph in parallel from any thread by representing all interactions with the graph as /operations/ enqueued to a lock-free Multi Producer, Single Consumer (MPSC) queue, and a background thread processes operations submitted to the queue.</p><p>When an operation is desired (adding a parent to a child, querying the children or parent of a node, etc.) it is enqueued. Write operations (like adding a parent to a child) require only a lock-free submission to the queue, making writes super efficient even when there would otherwise be contention - and read operations are similarly handled (just with an atomic &lsquo;done&rsquo; signal and a memory pool for getting results out.)</p><p>Lastly, we use lock-free pools of nodes and queue entries to allow for pre-allocating things like nodes in the graph and queue entries - potentially based on the applications&rsquo; actual measured usage to eliminate runtime allocations in future builds of the program.</p><h2 id=api-usage>API usage</h2><p>Object relations are accessible through any <code>mach.Objects</code> list, using the following APIs:</p><ul><li><code>.is(object_id)</code> returns a bool indicating if the given object is alive, valid, and from this pool of objects.</li><li><code>.getParent(child_id)</code> -> returns an error, null, or parent object ID</li><li><code>.setParent(child_id, parent_id)</code></li><li><code>.addChild(parent_id, child_id)</code></li><li><code>.removeChild(parent_id, child_id)</code></li><li><code>.getChildren(parent_id)</code> -> returns an error or <code>results</code> object with dynamic-size <code>.items</code> <code>[]const ObjectID</code> field<ul><li>Call <code>results.deinit()</code> to return memory for reuse by future <code>getChildren()</code> calls.</li></ul></li></ul><p>Consult the actual code for specific behavior.</p><h2 id=thats-all-there-is-to-it>That&rsquo;s all there is to it!</h2><p>Congratulations, you&rsquo;ve read all the documentation for the Mach object system!</p></div><div class=toc><h3>Table of contents</h3><nav id=TableOfContents><ul><li><a href=#relations-are-objectid---objectid>Relations are ObjectID &lt;-> ObjectID</a></li><li><a href=#the-parallelism-problem>The parallelism problem</a></li><li><a href=#how-machs-object-system-stores-relations>How Mach&rsquo;s object system stores relations</a></li><li><a href=#api-usage>API usage</a></li><li><a href=#thats-all-there-is-to-it>That&rsquo;s all there is to it!</a></li></ul></nav></div></main><div class=footer><a href=https://hexops.com/privacy>Privacy matters</a><p><a href=https://github.com/hexops/machengine.org/archive/refs/heads/gh-pages.zip>offline version of this site</a> | <a href=https://machengine.org//about#improve-this-site>Improve this site</a> | <a href=https://github.com/sponsors/emidoots>Sponsor on GitHub</a> | <a href=https://devlog.hexops.com/>Hexops' devlog</a></p></div></div></body></html>